# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# POLITECH AWARDS 2026 ‚Äî PR VOTING WORKFLOW
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#
# Each PR is an iteration on the voting mechanism. Committee members vote by
# submitting GitHub reviews:
#
#   ‚úÖ Approve         = YES vote
#   ‚ùå Request Changes = NO vote
#
# Majority approval required to merge. Voting window: 48 hours.
#
# Labels:
#   vote:approved         ‚Äî Majority approved
#   vote:rejected         ‚Äî Majority rejected
#   vote:pending          ‚Äî Awaiting votes
#   vote:deadline-passed  ‚Äî 48 hours have passed
#   ready-to-merge        ‚Äî Approved, awaiting manual merge
#
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

name: PR Voting

on:
  pull_request:
    types: [opened]
  pull_request_review:
    types: [submitted]
  schedule:
    - cron: '0 */6 * * *'  # Check deadlines every 6 hours

permissions:
  pull-requests: write
  contents: read

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # NOTIFY ‚Äî Post voting instructions when a PR is opened
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  notify:
    if: github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const deadline = new Date(Date.now() + 48*60*60*1000).toISOString().slice(0,16) + ' UTC';
            await github.rest.issues.addLabels({ ...context.repo, issue_number: context.issue.number, labels: ['vote:pending'] });
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: `üó≥Ô∏è **Voting open until ${deadline}** (48 hours)\n\nCommittee: approve or request changes to cast your vote. Majority required to merge.`
            });

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # TALLY ‚Äî Count votes after each review submission
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  tally:
    if: github.event_name == 'pull_request_review'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/github-script@v7
        with:
          script: |
            // Parse committee members from CODEOWNERS
            const fs = require('fs');
            const codeowners = fs.readFileSync('.github/CODEOWNERS', 'utf8');
            const members = codeowners.match(/@[\w-]+/g)?.map(m => m.slice(1).toLowerCase()) || [];
            const majority = Math.floor(members.length / 2) + 1;

            // Fetch all reviews on this PR
            const reviews = await github.rest.pulls.listReviews({
              ...context.repo,
              pull_number: context.issue.number
            });

            // Get latest vote from each committee member
            const votes = {};
            reviews.data.forEach(r => {
              if (members.includes(r.user.login.toLowerCase())) {
                votes[r.user.login.toLowerCase()] = r.state;
              }
            });

            // Count the votes
            const yes = Object.values(votes).filter(v => v === 'APPROVED').length;
            const no = Object.values(votes).filter(v => v === 'CHANGES_REQUESTED').length;
            const pending = members.length - Object.keys(votes).length;

            // Determine status and label
            let status, label;
            if (yes >= majority) {
              status = '‚úÖ Approved';
              label = 'vote:approved';
            } else if (no >= majority) {
              status = '‚ùå Rejected';
              label = 'vote:rejected';
            } else {
              status = `‚è≥ ${yes}/${majority} approvals`;
              label = 'vote:pending';
            }

            // Update labels (remove old vote labels, add current)
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({ ...context.repo, issue_number: context.issue.number });
            for (const l of currentLabels.filter(l => l.name.startsWith('vote:') && l.name !== 'vote:deadline-passed')) {
              await github.rest.issues.removeLabel({ ...context.repo, issue_number: context.issue.number, name: l.name }).catch(() => {});
            }
            await github.rest.issues.addLabels({ ...context.repo, issue_number: context.issue.number, labels: [label] });

            // Post tally update
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: `**${status}** ‚Äî ${yes} yes, ${no} no, ${pending} pending`
            });

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # DEADLINE ‚Äî Resolve PRs past the 48-hour window
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  deadline:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { data: prs } = await github.rest.pulls.list({ ...context.repo, state: 'open' });
            const cutoff = Date.now() - 48*60*60*1000;

            // Parse committee members from CODEOWNERS
            const codeowners = fs.readFileSync('.github/CODEOWNERS', 'utf8');
            const members = codeowners.match(/@[\w-]+/g)?.map(m => m.slice(1).toLowerCase()) || [];
            const membersOriginal = codeowners.match(/@[\w-]+/g)?.map(m => m.slice(1)) || [];
            const majority = Math.floor(members.length / 2) + 1;

            for (const pr of prs) {
              if (new Date(pr.created_at) >= cutoff) continue;

              // Check if already processed
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({ ...context.repo, issue_number: pr.number });
              if (labels.some(l => l.name === 'vote:deadline-passed')) continue;

              // Tally final votes
              const reviews = await github.rest.pulls.listReviews({ ...context.repo, pull_number: pr.number });
              const votes = {};
              reviews.data.forEach(r => {
                if (members.includes(r.user.login.toLowerCase())) {
                  votes[r.user.login.toLowerCase()] = r.state;
                }
              });

              const yes = Object.values(votes).filter(v => v === 'APPROVED').length;
              const no = Object.values(votes).filter(v => v === 'CHANGES_REQUESTED').length;
              const approved = yes >= majority;
              const rejected = no >= majority;

              // Add deadline label
              await github.rest.issues.addLabels({ ...context.repo, issue_number: pr.number, labels: ['vote:deadline-passed'] });

              if (approved) {
                // Pick a random codeowner to merge
                const assignee = membersOriginal[Math.floor(Math.random() * membersOriginal.length)];
                
                await github.rest.issues.addLabels({ ...context.repo, issue_number: pr.number, labels: ['ready-to-merge'] });
                await github.rest.issues.addAssignees({ ...context.repo, issue_number: pr.number, assignees: [assignee] });
                await github.rest.issues.createComment({
                  ...context.repo,
                  issue_number: pr.number,
                  body: `‚è∞ **Voting closed ‚Äî APPROVED**\n\nFinal tally: ${yes} yes, ${no} no\n\n‚úÖ @${assignee} ‚Äî please review and merge when ready.`
                });

              } else if (rejected) {
                // Pick a random codeowner to close
                const assignee = membersOriginal[Math.floor(Math.random() * membersOriginal.length)];
                
                await github.rest.issues.addAssignees({ ...context.repo, issue_number: pr.number, assignees: [assignee] });
                await github.rest.issues.createComment({
                  ...context.repo,
                  issue_number: pr.number,
                  body: `‚è∞ **Voting closed ‚Äî REJECTED**\n\nFinal tally: ${yes} yes, ${no} no\n\n‚ùå @${assignee} ‚Äî please close this PR.`
                });

              } else {
                // No majority ‚Äî leave open for committee discussion
                await github.rest.issues.createComment({
                  ...context.repo,
                  issue_number: pr.number,
                  body: `‚è∞ **Voting closed ‚Äî NO MAJORITY**\n\nFinal tally: ${yes} yes, ${no} no (needed ${majority})\n\nü§î Committee should discuss and reach consensus.`
                });
              }
            }
